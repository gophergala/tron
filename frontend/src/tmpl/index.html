<html>

<head>
  <style>
    body {
      padding: 20px;
    }
    #map {
      float: left;
      width: 1000px;
      height: 600px;
      border: 3px solid black;
    }
    #player-state {
      float: left;
      font-family: sans-serif;
      font-size: 36px;
    }
  </style>
</head>

<body>
  
  <canvas id="map" width="1000", height="600"></canvas>
  <div id="player-state"></div>
  
  <script>
    var DOM = {};
    DOM.map         = document.getElementById('map');
    DOM.playerState = document.getElementById('player-state');
    
    
    // mapState, playerColor, playerState ('wait', '5'..'1', 'play', 'won', 'lost')
    
    var mapState = {
      orange: [
        [333,200], [333,300], [200,300], [200,100]
      ],
      blue : [
        [666,200], [800,200], [800,50], [900,50]
      ],
      red: [
        [333,400], [100, 400], [100, 580], [200, 580]
      ],
      green: [
        [666,400], [850,400], [850,575], [950, 575]
      ]
    }
    
    var drawMap = function(mapState) {
      var ctx = DOM.map.getContext('2d');
      
      ctx.lineWidth = 1;
      
      for (var color in mapState) {
        if (mapState.hasOwnProperty(color)) {
          
          ctx.beginPath();
          ctx.strokeStyle = color;
          
          var coords = mapState[color];
          ctx.moveTo(coords[0][0], coords[0][1]);
          for (i = 1; i < coords.length; i++) { 
            ctx.lineTo(coords[i][0], coords[i][1]);
          }
          
          ctx.stroke();
          ctx.closePath();
        }
      }
    }
    
    drawMap(mapState);
    
    
    // --- SOCKETS SETUP -----------------------------------
    
    var webSocketURL = 'ws://localhost:8080/chatWS'
    var socket       = new WebSocket(webSocketURL);
    // var playerColor;
    // var playerState;
    var playerColor = 'blue';  // tmp
    var playerState = 'play';  // tmp
    
    socket.onopen = function() {
      socket.send(composeReadyEvent());
      
      window.onbeforeunload = function() {
        socket.close();
      }
    }
    
    socket.onmessage = function(event) {
      drawMap(event.mapState);
      
      if (playerState != event.playerState) {
        playerState = event.playerState;
        DOM.playerState.innerHTML = playerState;
        
        if (playerState == 'play') {
          playerColor = event.playerColor;
          document.onkeydown = sendKeyEvent;
        }
      }
    }
    
    function sendKeyEvent(e) {
      if (playerColor && playerState == 'play') {
        e = e || window.event;
        var direction;
        
        switch(e.keyCode) {
          case 37:
            direction = 'l';
            break;
          case 38:
            direction = 'u';
            break;
          case 39:
            direction = 'r';
            break;
          case 40:
            direction = 'd';
            break;
        }
        
        // socket.send(composeEvent(direction));
        console.log(composeKeyEvent(direction));  // tmp
        
      }      
    }
    
    // --- COMPOSE EVENT MESSAGES -------------------------
    
    function composeReadyEvent() {
      var msg = { type: 'ready' }
      return JSON.stringify(msg);
    }
    
    function composeKeyEvent(direction) {
      var msg = {
        type:        'key'
        direction:   direction
      }
      return JSON.stringify(msg);
    }
    
  </script>

</body>
</html>