<html>

<head>
  <style>
    body {
      padding: 20px;
    }
    #map {
      float: left;
      width: 1000px;
      height: 600px;
      border: 3px solid black;
    }
    #error {
      float: left;
      font-family: sans-serif;
      font-size: 36px;
      color: red;
    }
  </style>
</head>

<body>
  
  <canvas id="map" width="1000", height="600"></canvas>
  <div id="error"></div>
  
  <script>
    var DOM = {};
    DOM.map   = document.getElementById('map');
    DOM.error = document.getElementById('error');
    
    // mapState, playerColor, playerState ('wait', '5'..'1', 'play', 'won', 'lost')
    
    // var mapState = {
    //   orange: [
    //     [333,200], [333,300], [200,300], [200,100]
    //   ],
    //   blue : [
    //     [666,200], [800,200], [800,50], [900,50]
    //   ],
    //   red: [
    //     [333,400], [100, 400], [100, 580], [200, 580]
    //   ],
    //   green: [
    //     [666,400], [850,400], [850,575], [950, 575]
    //   ]
    // }
    // 
    var drawMap = function(mapState) {
      var ctx = DOM.map.getContext('2d');
      
      ctx.lineWidth = 1;
      
      for (var color in mapState) {
        if (mapState.hasOwnProperty(color)) {
          
          ctx.beginPath();
          ctx.strokeStyle = color;
          
          var coords = mapState[color];
          ctx.moveTo(coords[0][0], coords[0][1]);
          for (i = 1; i < coords.length; i++) { 
            ctx.lineTo(coords[i][0], coords[i][1]);
          }
          
          ctx.stroke();
          ctx.closePath();
        }
      }
    }
    
    
    // --- SOCKETS SETUP -----------------------------------
    
    var webSocketURL = 'ws://localhost:8080/Join'
    var socket       = new WebSocket(webSocketURL);
    var roomName     = 'tron'
    
    var playerColor;
    // var playerColor = 'blue';  // tmp
    
    socket.onopen = function() {
      socket.send(composeJoinMessage(roomName));
      
      window.onbeforeunload = function() {
        socket.close();
      }
    }
    
    socket.onmessage = function(msgJSON) {
      var msg = JSON.parse(msgJSON);
      
      switch(msg.type) {
        case 'Ready':
          playerColor = msg.Color;
          // display which color belongs to the player
          document.onkeydown = sendKeyMessage;
          break;
        case 'RefreshMap':
          drawMap(msg.State);
          break;
        case 'Error':
          displayErrorMessage(msg.Msg);
          break;
      }
    }
    
    function displayErrorMessage(Msg) {
      DOM.error.innerHTML = Msg;
    }
    
    function sendKeyMessage(e) {
        e = e || window.event;
        var direction;
        switch(e.keyCode) {
          case 37:
            direction = 'l';
            break;
          case 38:
            direction = 'u';
            break;
          case 39:
            direction = 'r';
            break;
          case 40:
            direction = 'd';
            break;
        }
        socket.send(composeKeyMessage(direction));
        // console.log(composeKeyMessage(direction));  // tmp
    }
    
    // --- COMPOSE EVENT MESSAGES -------------------------
    
    function composeJoinMessage(roomName) {
      var msg = {
        Type: 'Join' ,
        Room: roomName
      }
      return JSON.stringify(msg);
    }
    
    function composeKeyMessage(direction) {
      var msg = {
        Type:      'Move' ,
        Direction: direction
      }
      return JSON.stringify(msg);
    }
    
  </script>

</body>
</html>